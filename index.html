<!--

Copyright 2024 Chris MacMackin

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or (at
your option) any later version.

This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.

-->

<!DOCTYPE html>
    <html lang="en">
    <head>
        <!-- Load plotly.js into the DOM -->
        <script src='https://cdn.plot.ly/plotly-2.34.0.min.js'></script>
        <!-- Load Grist extension API into DOM -->
        <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    </head>
    
    <body>
      <div id='chart'>Waiting for data...</div>
	  <script>
		function percentage(num, denom) {
			return num.map((n, i) => n / denom[i] * 100);
		}
		grist.ready({
			requiredAccess: 'read table',
			columns: [
				{
					name: "Hierarchy",
					title: "Hierarchical data",
					description: "The 'path' to each sector of the plot",
					type: "ChoiceList,RefList"
				},
				{
					name: "Size",
					title: "Sector size",
					//description: "Number of people represented by each sector of the plot",
					type: "Int"
				},
				{
					name: "Coverage",
					title: "Sector coverage",
					description: "Number of people considered 'covered' in each sector of the plot",
					type: "Int",
					allowMultiple: true
				},
			]
		});
		grist.onRecords(async function(records, mapping) {
			console.log(mapping);
			const mapped = grist.mapColumnNames(records);
			const wrap = (s) => s.replace(
				/(?![^\n]{1,28}$)([^\n]{1,28})\s/g, '$1<br>'
			);
			if (mapped) {
    			var data = [{
    				type: "sunburst",
    				labels: mapped.Hierarchy.map((h) => wrap(h[h.length - 1])),
    				ids: mapped.Hierarchy.map((h) => h.toString()),
    				parents: mapped.Hierarchy.map((h) => h.slice(0, -1).toString()),
    				values:  mapped.Size,
    				customdata: mapped.Coverage[0],
    				hovertemplate: "<b>%{label}</b> <br> Employees: %{value} <br> Members: %{customdata}, %{color:.2f}%<extra></extra>",
    				branchvalues: "total",
    				marker: {
    					"colors": percentage(mapped.Coverage[0], mapped.Size),
    					"colorscale": [
							["0.0", "rgb(165,0,38)"],
							["0.1", "rgb(215,48,39)"],
							["0.2", "rgb(244,109,67)"],
							["0.3", "rgb(253,174,97)"],
							["0.4", "rgb(254,224,139)"],
							["0.5", "rgb(255,255,191)"],
							["0.6", "rgb(217,239,139)"],
							["0.7", "rgb(166,217,106)"],
							["0.8", "rgb(102,189,99)"],
							["0.9", "rgb(26,152,80)"],
							["1.0", "rgb(0,104,55)"],
						],
						"showscale": true,
    				},
					maxdepth: 2,
    			}];
    			var layout = {
    				margin: {l: 10, r: 10, b: 10, t: 10},
					cmin: 0,
					cmax: 100,
    			};
				var config = {responsive: true};
				document.getElementById('chart').innerText = "";
				Plotly.newPlot('chart', data, layout, config);
			} else {
				document.getElementById('chart').innerText = "Please map all columns";
				console.error("Please map all columns");
			}			
		}, {format: "columns"});
	  </script>
    </body>
</html>
